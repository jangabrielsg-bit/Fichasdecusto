<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fichas de Custo - Controle de Qualidade</title>
    
    <!-- Tailwind CSS (Estilização Moderna) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>

    <!-- Configurações do Tailwind para animações -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideIn: { '0%': { transform: 'translateX(20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-in-from-right-4': 'slideIn 0.3s ease-out'
                    }
                }
            }
        }
    </script>

    <!-- Import Map: Define onde buscar o React e Lucide Icons na internet -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "xlsx": "https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs"
        }
    }
    </script>
    
    <!-- Babel: Traduz o código React (JSX) para o navegador entender -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Biblioteca XLSX para leitura de Excel (Global Fallback) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Estilos Personalizados de Barra de Rolagem */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Garantir impressão limpa */
        @media print {
            @page { margin: 0; size: auto; }
            body { -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-[#fdfbf7] text-stone-900 min-h-screen">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Trash2, Save, FileText, Calculator, ChevronLeft, Printer, PieChart, 
            Package, Clock, Zap, Percent, Filter, Settings, Edit2, X, Tag, AlertTriangle, 
            Upload, Download, Sparkles, Bot, Loader2, Users, Copy, TrendingUp, DollarSign, 
            Archive, FileSpreadsheet, Image as ImageIcon, Coins, Search, Link as LinkIcon, 
            Unlink, Database, ExternalLink 
        } from 'lucide-react';

        // --- CONFIGURAÇÃO DA API ---
        // COLOQUE SUA CHAVE AQUI PARA A I.A. FUNCIONAR
        const apiKey = ""; 

        // "Não se gerencia o que não se mede, não se mede o que não se define..."
        console.log("Fichas de Custo - Controle de Qualidade iniciado.");

        // --- Cores da Marca (IMAC) ---
        const BRAND = {
            brown: '#482823', // Marrom Café
            brownLight: '#6d4c41',
            yellow: '#FDB913', // Amarelo Ouro
            bg: '#fdfbf7' // Fundo creme suave
        };

        // --- Helper Functions ---
        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        };

        const safeVal = (val) => {
            if (val === null || val === undefined || val === '') return 0;
            if (typeof val === 'string') {
                val = val.replace(',', '.');
            }
            const num = parseFloat(val);
            return isNaN(num) ? 0 : num;
        };

        const formatMoney = (val) => {
            return safeVal(val).toFixed(2);
        };

        // Funçao robusta para extrair JSON da IA
        const extractJSON = (text) => {
            try {
                if (!text) return null;
                const markdownMatch = text.match(/```json\s*([\s\S]*?)\s*```/) || text.match(/```\s*([\s\S]*?)\s*```/);
                let jsonText = markdownMatch ? markdownMatch[1] : text;
                const firstOpen = jsonText.indexOf('{');
                if (firstOpen === -1) {
                    const firstArray = jsonText.indexOf('[');
                    if (firstArray !== -1) return JSON.parse(jsonText);
                    try { return JSON.parse(jsonText); } catch(e) {}
                    return null;
                }
                let balance = 0;
                let endIndex = -1;
                for (let i = firstOpen; i < jsonText.length; i++) {
                    if (jsonText[i] === '{') balance++;
                    else if (jsonText[i] === '}') balance--;
                    if (balance === 0) {
                        endIndex = i;
                        break;
                    }
                }
                if (endIndex !== -1) {
                    const extracted = jsonText.substring(firstOpen, endIndex + 1);
                    return JSON.parse(extracted);
                }
                return JSON.parse(jsonText);
            } catch (e) {
                try {
                    const cleaned = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    return JSON.parse(cleaned);
                } catch (err2) {
                    return null;
                }
            }
        };

        // --- Componentes UI Básicos ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-stone-200 ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = "primary", className = "", disabled = false, ...props }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all active:scale-95 flex items-center gap-2 justify-center";
            
            const variants = {
                primary: `text-white hover:opacity-90 disabled:opacity-50 shadow-sm`,
                secondary: "bg-white text-stone-700 hover:bg-stone-50 border border-stone-200 disabled:bg-stone-50 disabled:text-stone-400 shadow-sm",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100",
                success: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm",
                outline: "border border-stone-300 text-stone-700 hover:bg-stone-50",
                ghost: "text-stone-600 hover:bg-stone-100",
                magic: "bg-gradient-to-r from-amber-500 to-yellow-500 text-white hover:from-amber-600 hover:to-yellow-600 shadow-md border-0"
            };

            const style = variant === 'primary' ? { backgroundColor: BRAND.brown } : {};

            return (
                <button 
                onClick={onClick} 
                disabled={disabled}
                className={`${baseStyle} ${variants[variant]} ${className} ${disabled ? 'cursor-not-allowed opacity-70' : ''}`}
                style={style}
                {...props}
                >
                {children}
                </button>
            );
        };

        const DonutChart = ({ data }) => {
            let cumulativePercent = 0;
            
            const getCoordinatesForPercent = (percent) => {
                const x = Math.cos(2 * Math.PI * percent);
                const y = Math.sin(2 * Math.PI * percent);
                return [x, y];
            };

            if (!data || data.length === 0 || data.every(d => d.value === 0)) {
                return (
                    <div className="flex items-center justify-center h-40 bg-stone-50 rounded-full w-40 mx-auto border-4 border-stone-100">
                        <span className="text-xs text-stone-400">Sem dados</span>
                    </div>
                );
            }

            const total = data.reduce((acc, curr) => acc + curr.value, 0);

            return (
                <div className="relative w-40 h-40 mx-auto">
                <svg viewBox="-1 -1 2 2" className="transform -rotate-90 w-full h-full">
                    {data.map((slice, i) => {
                    if (slice.value === 0) return null;
                    const percent = slice.value / total;
                    const [startX, startY] = getCoordinatesForPercent(cumulativePercent);
                    cumulativePercent += percent;
                    const [endX, endY] = getCoordinatesForPercent(cumulativePercent);
                    const largeArcFlag = percent > 0.5 ? 1 : 0;
                    const pathData = [
                        `M ${startX} ${startY}`,
                        `A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY}`,
                        `L 0 0`,
                    ].join(' ');
                    
                    return (
                        <path d={pathData} fill={slice.color} key={i} stroke="white" strokeWidth="0.02" />
                    );
                    })}
                    <circle cx="0" cy="0" r="0.6" fill="white" />
                </svg>
                <div className="absolute inset-0 flex items-center justify-center flex-col">
                    <span className="text-[10px] text-stone-400 font-medium">Custo Total</span>
                    <span className="text-sm font-bold text-stone-800">R${formatMoney(total)}</span>
                </div>
                </div>
            );
        };

        // --- Modais ---
        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 border border-stone-100 transform transition-all scale-100">
                    <div className="flex items-center gap-3 text-red-600 mb-4 bg-red-50 p-3 rounded-lg w-fit">
                        <AlertTriangle size={24} />
                    </div>
                    <h3 className="text-lg font-bold text-stone-900 mb-2">{title}</h3>
                    <p className="text-stone-600 mb-6 leading-relaxed text-sm">{message}</p>
                    <div className="flex justify-end gap-3">
                    <Button variant="secondary" onClick={onClose}>Cancelar</Button>
                    <Button variant="danger" onClick={onConfirm}>Confirmar</Button>
                    </div>
                </div>
                </div>
            );
        };

        const AlertModal = ({ isOpen, onClose, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full mx-4">
                    <h3 className="text-lg font-bold text-stone-900 mb-2">Atenção</h3>
                    <p className="text-stone-600 mb-6">{message}</p>
                    <div className="flex justify-end">
                        <Button variant="primary" onClick={onClose}>Entendido</Button>
                    </div>
                    </div>
                </div>
            );
        };

        const SelectIngredientModal = ({ isOpen, onClose, ingredients, onSelect }) => {
            const [search, setSearch] = useState('');
            
            if (!isOpen) return null;

            const filtered = ingredients.filter(i => i.name.toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full mx-4 flex flex-col max-h-[80vh]">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-stone-900">Selecionar Insumo</h3>
                            <button onClick={onClose}><X size={20} className="text-stone-400" /></button>
                        </div>
                        
                        <div className="relative mb-4">
                            <Search className="absolute left-3 top-2.5 text-stone-400" size={18} />
                            <input 
                                className="w-full pl-10 pr-4 py-2 border rounded-lg bg-stone-50 outline-none focus:ring-2 focus:ring-amber-500" 
                                placeholder="Buscar matéria-prima..."
                                value={search}
                                onChange={e => setSearch(e.target.value)}
                                autoFocus
                            />
                        </div>

                        <div className="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                            {filtered.length === 0 ? (
                                <p className="text-center text-stone-400 py-4">Nenhum insumo encontrado.</p>
                            ) : (
                                filtered.map(ing => (
                                    <button 
                                        key={ing.id}
                                        onClick={() => onSelect(ing)}
                                        className="w-full text-left p-3 hover:bg-amber-50 rounded-lg border border-stone-100 transition-colors flex justify-between items-center group"
                                    >
                                        <div>
                                            <div className="font-medium text-stone-800">{ing.name}</div>
                                            <div className="text-xs text-stone-500">Unidade: {ing.unit}</div>
                                        </div>
                                        <div className="text-right">
                                            <div className="font-bold text-amber-700">R$ {formatMoney(ing.price)}</div>
                                        </div>
                                    </button>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Modal de Importação Inteligente
        const ImportModal = ({ isOpen, onClose, onImport }) => {
            const [mode, setMode] = useState('text'); // text | image | excel
            const [textInput, setTextInput] = useState('');
            const [selectedImage, setSelectedImage] = useState(null);
            const [imagePreview, setImagePreview] = useState(null);
            const [selectedExcel, setSelectedExcel] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setSelectedImage(file);
                    const reader = new FileReader();
                    reader.onloadend = () => setImagePreview(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleExcelChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setSelectedExcel(file);
                }
            }

            const processImport = async () => {
                if (!apiKey) return setError("API Key não configurada. Edite o código para adicionar sua chave.");
                if (mode === 'text' && !textInput.trim()) return setError('Por favor, cole o texto da planilha.');
                if (mode === 'image' && !selectedImage) return setError('Por favor, selecione uma imagem.');
                if (mode === 'excel' && !selectedExcel) return setError('Por favor, selecione um arquivo Excel.');

                setLoading(true);
                setError('');

                try {
                    let promptContent = "";
                    let inlineData = null;

                    if (mode === 'excel') {
                        if (!window.XLSX) throw new Error("Biblioteca Excel não carregada.");
                        
                        const data = await selectedExcel.arrayBuffer();
                        const workbook = window.XLSX.read(data);
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const csvText = window.XLSX.utils.sheet_to_csv(worksheet);
                        promptContent = `Extraia os dados desta planilha Excel (formato CSV):\n${csvText}`;
                    } else if (mode === 'text') {
                        promptContent = `Extraia os dados desta tabela/texto:\n${textInput}`;
                    } else if (mode === 'image') {
                        const base64Data = imagePreview.split(',')[1];
                        inlineData = { mimeType: selectedImage.type, data: base64Data };
                    }

                    const systemPrompt = `
                    Você é um especialista em conversão de planilhas de padaria para JSON.
                    **ESTRUTURA DE DADOS (Cabeçalho típico):**
                    Linha 1-4: 'Produto', 'Rendimentos', 'Peso da unidade'.
                    Linha 5 (Cabeçalho): 'Tipo de Custo', 'Ingredientes', 'Marca', 'Quantidade', 'Preço unitário (kg)', 'Unidade', 'Custo por batelada (R$)', 'Custo por kg'.
                    **REGRAS DE EXTRAÇÃO CRÍTICAS:**
                    1. **INSUMOS ('direct')**: (Farinha, Fermento, Sal, Ingredientes de massa).
                    2. **MÃO DE OBRA ('labor')**: Force a 'quantity' = 1 e a 'unit' = 'lote'.
                    3. **MAQUINÁRIO ('energy')**: Use 'quantity' = 1, 'unit' = 'lote'.
                    4. **CUSTOS INDIRETOS ('indirect')**: Use 'quantity' = 1, 'unit' = 'un'.
                    
                    **Formatação de Saída (JSON Puro):**
                    { "name": "Nome", "yieldUnit": 1, "unitWeight": 0, "items": [{ "name": "Item", "quantity": 1, "unit": "kg", "cost": 10.0, "category": "direct" }] }
                    `;

                    let contents = [];
                    if (inlineData) {
                        contents = [{
                            parts: [
                                { text: "Extraia os dados desta imagem seguindo estritamente as regras de planilha de padaria:" },
                                { inlineData: inlineData }
                            ]
                        }];
                    } else {
                        contents = [{ parts: [{ text: promptContent }] }];
                    }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: contents,
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);

                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    const parsedData = extractJSON(text);
                    
                    if (parsedData) {
                        if(!parsedData.items) parsedData.items = [];
                        parsedData.yieldUnit = parsedData.yieldUnit || 1;
                        onImport(parsedData);
                        onClose();
                    } else {
                        setError("Não foi possível extrair um JSON válido da resposta.");
                    }

                } catch (err) {
                    console.error(err);
                    setError(`Erro: ${err.message || "Não foi possível interpretar os dados."}`);
                } finally {
                    setLoading(false);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full mx-4 border border-stone-200 flex flex-col max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-stone-900 flex items-center gap-2" style={{color: BRAND.brown}}>
                                <FileSpreadsheet /> Importar Planilha
                            </h3>
                            <button onClick={onClose} className="text-stone-400 hover:text-stone-600"><X size={24} /></button>
                        </div>

                        <div className="flex gap-2 mb-4 bg-stone-100 p-1 rounded-lg">
                            <button onClick={() => setMode('excel')} className={`flex-1 py-2 text-xs font-medium rounded-md transition-colors ${mode === 'excel' ? 'bg-white text-green-600 shadow-sm' : 'text-stone-600 hover:bg-stone-200'}`}><FileSpreadsheet size={14} className="inline mr-1" /> Excel</button>
                            <button onClick={() => setMode('image')} className={`flex-1 py-2 text-xs font-medium rounded-md transition-colors ${mode === 'image' ? 'bg-white shadow-sm' : 'text-stone-600 hover:bg-stone-200'}`} style={mode === 'image' ? {color: BRAND.brown} : {}}><ImageIcon size={14} className="inline mr-1" /> Imagem</button>
                            <button onClick={() => setMode('text')} className={`flex-1 py-2 text-xs font-medium rounded-md transition-colors ${mode === 'text' ? 'bg-white shadow-sm' : 'text-stone-600 hover:bg-stone-200'}`} style={mode === 'text' ? {color: BRAND.brown} : {}}><FileText size={14} className="inline mr-1" /> Texto</button>
                        </div>

                        <div className="flex-1 overflow-y-auto min-h-0 mb-4">
                            {mode === 'text' && (
                                <textarea 
                                    className="w-full h-48 border border-stone-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-amber-500 outline-none resize-none"
                                    placeholder={`Exemplo:\nFarinha 1kg R$5.00\nAçúcar 500g R$2.00`}
                                    value={textInput}
                                    onChange={(e) => setTextInput(e.target.value)}
                                />
                            )}
                            {mode === 'image' && (
                                <div className="border-2 border-dashed border-stone-300 rounded-lg p-6 flex flex-col items-center justify-center text-center relative">
                                    <input type="file" accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleImageChange} />
                                    {imagePreview ? <img src={imagePreview} alt="Preview" className="max-h-48 rounded object-contain" /> : <><Upload className="w-10 h-10 text-stone-400 mb-2" /><p className="text-sm text-stone-600">Enviar foto</p></>}
                                </div>
                            )}
                            {mode === 'excel' && (
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <input type="file" accept=".xlsx, .xls, .csv" onChange={handleExcelChange} className="w-full text-sm text-stone-500" />
                                </div>
                            )}
                            {error && <div className="mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-center gap-2"><AlertTriangle size={16} /> {error}</div>}
                        </div>

                        <div className="flex justify-end pt-4 border-t border-stone-100">
                            <Button variant="magic" onClick={processImport} disabled={loading} className="w-full">
                                {loading ? <Loader2 size={18} className="animate-spin" /> : <><Sparkles size={18} /> Processar</>}
                            </Button>
                        </div>
                    </div>
                </div>
            );
        };

        const AIModal = ({ isOpen, onClose, mode, onGenerate, productToAnalyze, kwhPrice }) => {
            const [prompt, setPrompt] = useState("");
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState("");

            useEffect(() => {
                if (!isOpen) {
                    setResult(null);
                    setError("");
                    setLoading(false);
                }
            }, [isOpen]);

            const handleGenerate = async () => {
                if (!apiKey) return setError("API Key não configurada.");
                if (!prompt.trim()) return;
                setLoading(true);
                setError("");
                setResult(null);

                try {
                    const systemPrompt = `Você é um chef especialista em padaria e confeitaria com foco em custos.
                    Crie uma ficha técnica realista para o produto solicitado.
                    Retorne APENAS um JSON válido.
                    Estrutura do JSON:
                    {
                        "name": "Nome do Produto",
                        "description": "Descrição curta e atraente",
                        "yieldUnit": número (rendimento TOTAL em KG da receita),
                        "unitWeight": número (peso de UMA unidade em KG),
                        "unitName": "unidades" (ou kg),
                        "sector": "confeitaria" | "padaria" | "salgados" | "geral",
                        "items": [
                        { "name": "Ingrediente", "quantity": número, "unit": "kg/l/un", "cost": número (preço unitário), "category": "direct" }
                        ]
                    }
                    `;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    const productData = extractJSON(text);
                    if (productData) {
                        onGenerate(productData);
                        onClose();
                    } else {
                        setError("Falha ao processar resposta da IA.");
                    }

                } catch (err) {
                    setError("Erro ao gerar receita: " + err.message);
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            const handleAnalyze = async () => {
                if (!apiKey) return setError("API Key não configurada.");
                setLoading(true);
                setError("");
                
                try {
                    const totalCost = productToAnalyze.items.reduce((acc, curr) => acc + (safeVal(curr.cost) * safeVal(curr.quantity)), 0);
                    
                    const analysisPrompt = `
                    Atue como um consultor financeiro de padaria sênior. Analise esta ficha de custo:
                    Produto: ${productToAnalyze.name}
                    Custo Total Insumos: R$ ${totalCost.toFixed(2)}
                    Lista de Itens:
                    ${productToAnalyze.items.map(i => `- ${i.name}: R$${(safeVal(i.quantity) * safeVal(i.cost)).toFixed(2)}`).join('\n')}
                    Forneça: 1. Análise Pareto (maiores custos). 2. Sugestões de economia. 3. Estratégia de precificação.
                    Responda em HTML simples.
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                        contents: [{ parts: [{ text: analysisPrompt }] }]
                        })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Sem análise gerada.";
                    setResult(text);

                } catch (err) {
                    setError("Falha na análise da IA: " + err.message);
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (mode === 'analyze' && isOpen && !result && !loading) {
                    handleAnalyze();
                }
            }, [mode, isOpen]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full mx-4 border border-amber-100 max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-start mb-6">
                        <div className="flex items-center gap-3">
                            <div className="bg-amber-100 p-2 rounded-lg">
                            <Sparkles className="text-amber-600 w-6 h-6" />
                            </div>
                            <div>
                            <h3 className="text-xl font-bold text-stone-900">
                                {mode === 'create' ? 'Chef IA: Criar Receita' : 'Consultor IA: Análise'}
                            </h3>
                            <p className="text-sm text-stone-500">
                                {mode === 'create' ? 'Descreva o produto e deixe a IA calcular.' : 'Insights inteligentes sobre sua ficha técnica.'}
                            </p>
                            </div>
                        </div>
                        <button onClick={onClose} className="text-stone-400 hover:text-stone-600"><X size={24} /></button>
                        </div>

                        <div className="flex-1 overflow-y-auto min-h-0 pr-2 custom-scrollbar">
                        {mode === 'create' ? (
                            <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-stone-700 mb-2">O que quer produzir hoje?</label>
                                <textarea 
                                className="w-full border border-stone-300 rounded-lg p-3 h-32 focus:ring-2 focus:ring-amber-500 outline-none resize-none transition-shadow"
                                placeholder="Ex: Bolo de Cenoura com cobertura de chocolate crocante. Rendimento de 2kg."
                                value={prompt}
                                onChange={(e) => setPrompt(e.target.value)}
                                />
                            </div>
                            <p className="text-xs text-stone-500 bg-amber-50 p-3 rounded-lg border border-amber-100">
                                <Bot size={14} className="inline mr-1 mb-0.5" />
                                A IA irá estimar ingredientes e quantidades. Sempre verifique os preços finais.
                            </p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                            {loading && (
                                <div className="flex flex-col items-center justify-center py-12 space-y-4">
                                <Loader2 className="w-10 h-10 text-amber-600 animate-spin" />
                                <p className="text-stone-500 animate-pulse">Consultando o chef virtual...</p>
                                </div>
                            )}
                            {result && (
                                <div 
                                    className="prose prose-sm max-w-none text-stone-700 bg-stone-50 p-6 rounded-lg border border-stone-100"
                                    dangerouslySetInnerHTML={{ __html: result.replace(/```html/g, '').replace(/```/g, '') }}
                                />
                            )}
                            </div>
                        )}
                        {error && (
                            <div className="mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-center gap-2">
                            <AlertTriangle size={16} /> {error}
                            </div>
                        )}
                        </div>

                        <div className="mt-6 pt-4 border-t border-stone-100 flex justify-end gap-3">
                        <Button variant="secondary" onClick={onClose}>Fechar</Button>
                        {mode === 'create' && (
                            <Button 
                            variant="magic" 
                            onClick={handleGenerate} 
                            disabled={loading || !prompt.trim()}
                            className="min-w-[140px]"
                            >
                            {loading ? <Loader2 size={18} className="animate-spin" /> : <><Sparkles size={18} /> Criar Mágica</>}
                            </Button>
                        )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Constantes Fixas de Estilo ---
        const SECTOR_COLORS = [
            'bg-amber-100 text-amber-800 border-amber-200 ring-amber-500',
            'bg-orange-100 text-orange-800 border-orange-200 ring-orange-500',
            'bg-stone-200 text-stone-800 border-stone-300 ring-stone-500',
            'bg-yellow-100 text-yellow-800 border-yellow-200 ring-yellow-500',
            'bg-red-100 text-red-800 border-red-200 ring-red-500',
            'bg-neutral-100 text-neutral-800 border-neutral-200 ring-neutral-500',
        ];

        const COST_CATEGORIES = {
            DIRECT: { id: 'direct', label: 'Insumos (Diretos)', icon: Package, color: 'text-amber-700', bg: 'bg-amber-50', barColor: '#d97706' },
            LABOR: { id: 'labor', label: 'Mão de Obra', icon: Clock, color: 'text-stone-600', bg: 'bg-stone-100', barColor: '#57534e' },
            ENERGY: { id: 'energy', label: 'Maquinário (Energia)', icon: Zap, color: 'text-yellow-600', bg: 'bg-yellow-50', barColor: '#ca8a04' },
            INDIRECT: { id: 'indirect', label: 'Custos Indiretos', icon: Coins, color: 'text-orange-600', bg: 'bg-orange-50', barColor: '#ea580c' }
        };

        const DEFAULT_SETTINGS = {
            kwhPrice: 0.95, 
            logo: null, 
            sectors: [
                { id: 'confeitaria', label: 'Confeitaria' },
                { id: 'salgados', label: 'Salgados' },
                { id: 'padaria', label: 'Padaria' },
                { id: 'geral', label: 'Geral' }
            ],
            machines: [
                { id: 1, name: 'Forno Elétrico Industrial', powerWatts: 5000 },
                { id: 2, name: 'Batedeira Planetária', powerWatts: 500 },
                { id: 3, name: 'Liquidificador Industrial', powerWatts: 800 },
                { id: 4, name: 'Microondas', powerWatts: 1200 }
            ],
            employees: [
                { id: 1, name: 'Confeiteiro Principal', salary: 2500, hoursMonth: 220 },
                { id: 2, name: 'Auxiliar de Cozinha', salary: 1412, hoursMonth: 220 }
            ]
        };

        const INITIAL_PRODUCT = {
            id: null,
            name: '',
            description: '',
            sector: 'geral',
            yieldUnit: 1, 
            unitWeight: 0, 
            unitName: 'unidades', 
            items: [],
            machineryItems: [],
            targetMargin: 50, 
            manualSalePrice: 0,
            pricingMode: 'divisor' 
        };

        // --- App Principal ---
        function App() {
            const [view, setView] = useState('dashboard');
            const [products, setProducts] = useState([]);
            const [currentProduct, setCurrentProduct] = useState(INITIAL_PRODUCT);
            const [activeFilter, setActiveFilter] = useState('all');
            const [settings, setSettings] = useState(DEFAULT_SETTINGS);
            
            // New State for Ingredients (Raw Materials)
            const [ingredients, setIngredients] = useState([]);
            const [newIngredient, setNewIngredient] = useState({ name: '', price: '', unit: 'kg', category: 'direct' });
            const [ingredientModalOpen, setIngredientModalOpen] = useState(false);
            const [activeItemForLinking, setActiveItemForLinking] = useState(null);

            const [newSectorName, setNewSectorName] = useState('');
            const [newMachine, setNewMachine] = useState({ name: '', powerWatts: '' });
            const [newEmployee, setNewEmployee] = useState({ name: '', salary: '', hoursMonth: 220 });
            const [laborSelection, setLaborSelection] = useState({ employeeId: '', minutes: '' });

            const fileInputRef = useRef(null);
            const backupInputRef = useRef(null);
            
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', onConfirm: null });
            const [alertModal, setAlertModal] = useState({ isOpen: false, message: '' });
            const [aiModal, setAiModal] = useState({ isOpen: false, mode: 'create' });
            const [importModal, setImportModal] = useState({ isOpen: false });

            useEffect(() => {
                try {
                const savedData = localStorage.getItem('costManagerData_v2');
                const savedSettings = localStorage.getItem('costManagerSettings');
                const savedIngredients = localStorage.getItem('costManagerIngredients');
                
                if (savedData) setProducts(JSON.parse(savedData));
                if (savedSettings) setSettings(JSON.parse(savedSettings));
                if (savedIngredients) setIngredients(JSON.parse(savedIngredients));
                } catch (e) {
                console.error("Erro ao carregar dados do local storage:", e);
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('costManagerData_v2', JSON.stringify(products));
            }, [products]);

            useEffect(() => {
                localStorage.setItem('costManagerSettings', JSON.stringify(settings));
            }, [settings]);

            useEffect(() => {
                localStorage.setItem('costManagerIngredients', JSON.stringify(ingredients));
            }, [ingredients]);

            const showAlert = (message) => setAlertModal({ isOpen: true, message });
            const closeAlert = () => setAlertModal({ ...alertModal, isOpen: false });
            
            const askConfirm = (title, message, action) => {
                setConfirmModal({
                    isOpen: true,
                    title,
                    message,
                    onConfirm: () => {
                        action();
                        setConfirmModal(prev => ({ ...prev, isOpen: false }));
                    }
                });
            };

            // Helper to get cost (linked or manual)
            const getItemCost = (item) => {
                if (item.ingredientId) {
                    const linkedIng = ingredients.find(i => i.id === item.ingredientId);
                    if (linkedIng) return linkedIng.price;
                }
                return item.cost;
            };

            const calculateMachineCost = (item) => {
                const machine = settings.machines.find(m => m.id == item.machineId) || { powerWatts: 0 };
                return (machine.powerWatts / 1000) * (safeVal(item.timeMinutes) / 60) * settings.kwhPrice;
            };

            // Funções de CRUD
            const handleCreateNew = () => { setCurrentProduct({ ...INITIAL_PRODUCT, id: generateId(), items: [], machineryItems: [] }); setView('edit'); };
            const handleEdit = (product) => { setCurrentProduct({ ...INITIAL_PRODUCT, ...JSON.parse(JSON.stringify(product)), machineryItems: product.machineryItems || [] }); setView('edit'); };
            const handleDuplicate = (product, e) => { if(e) e.stopPropagation(); setProducts(prev => [...prev, { ...JSON.parse(JSON.stringify(product)), id: generateId(), name: `${product.name} (Cópia)` }]); showAlert(`"${product.name}" foi duplicado.`); };
            const handleDelete = (id, e) => { if (e) e.stopPropagation(); askConfirm('Excluir?', 'Irreversível.', () => setProducts(products.filter(p => p.id !== id))); };
            const handleSaveProduct = () => { if (!currentProduct.name) return showAlert("Nome obrigatório."); setProducts(prev => { const idx = prev.findIndex(p => p.id === currentProduct.id); if (idx >= 0) { const copy = [...prev]; copy[idx] = currentProduct; return copy; } return [...prev, currentProduct]; }); setView('dashboard'); };
            
            const handleAddItem = (category) => setCurrentProduct(prev => ({ ...prev, items: [...prev.items, { id: generateId(), name: '', cost: 0, category, unit: 'un', quantity: 1 }] }));
            const handleRemoveItem = (id) => setCurrentProduct(prev => ({ ...prev, items: prev.items.filter(item => item.id !== id) }));
            const handleUpdateItem = (id, field, value) => setCurrentProduct(prev => ({ ...prev, items: prev.items.map(item => item.id === id ? { ...item, [field]: value } : item) }));
            
            const handleAddMachineUsage = () => { const def = settings.machines[0] || { id: 'temp', name: 'Máquina', powerWatts: 1000 }; setCurrentProduct(prev => ({ ...prev, machineryItems: [...prev.machineryItems, { id: generateId(), machineId: def.id, timeMinutes: 60 }] })); };
            const handleUpdateMachineUsage = (id, f, v) => setCurrentProduct(prev => ({ ...prev, machineryItems: prev.machineryItems.map(item => item.id === id ? { ...item, [f]: v } : item) }));
            const handleRemoveMachineUsage = (id) => setCurrentProduct(prev => ({ ...prev, machineryItems: prev.machineryItems.filter(item => item.id !== id) }));

            // Ingredients Logic
            const handleAddIngredient = () => {
                if(!newIngredient.name || !newIngredient.price) return showAlert("Nome e Preço obrigatórios");
                setIngredients(prev => [...prev, { ...newIngredient, id: generateId(), price: Number(newIngredient.price) }]);
                setNewIngredient({ name: '', price: '', unit: 'kg', category: 'direct' });
            };
            const handleDeleteIngredient = (id) => {
                askConfirm('Excluir do Estoque?', 'Itens vinculados em receitas perderão a atualização automática.', () => {
                    setIngredients(prev => prev.filter(i => i.id !== id));
                });
            };
            const handleUpdateIngredient = (id, field, value) => {
                setIngredients(prev => prev.map(i => i.id === id ? { ...i, [field]: value } : i));
            };

            const handleLinkItem = (item) => {
                setActiveItemForLinking(item);
                setIngredientModalOpen(true);
            };

            const handleSelectIngredientForLink = (ing) => {
                if (activeItemForLinking) {
                    handleUpdateItem(activeItemForLinking.id, 'name', ing.name);
                    handleUpdateItem(activeItemForLinking.id, 'unit', ing.unit);
                    handleUpdateItem(activeItemForLinking.id, 'ingredientId', ing.id);
                    handleUpdateItem(activeItemForLinking.id, 'cost', ing.price);
                }
                setIngredientModalOpen(false);
                setActiveItemForLinking(null);
            };

            const handleUnlinkItem = (item) => {
                const currentCost = getItemCost(item);
                handleUpdateItem(item.id, 'ingredientId', null);
                handleUpdateItem(item.id, 'cost', currentCost);
            };

            // Labor Logic
            const handleAddLaborItem = () => {
                if (!laborSelection.employeeId || !laborSelection.minutes) return showAlert("Selecione funcionário e tempo.");
                const emp = settings.employees.find(e => e.id == laborSelection.employeeId);
                if (!emp) return;
                const costMin = emp.salary / (emp.hoursMonth * 60);
                setCurrentProduct(prev => ({ ...prev, items: [...prev.items, { id: generateId(), name: emp.name, cost: costMin, quantity: Number(laborSelection.minutes), unit: 'min', category: 'labor' }] }));
                setLaborSelection({ employeeId: '', minutes: '' });
            };

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) return showAlert("A imagem deve ter menos de 2MB.");
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setSettings(prev => ({ ...prev, logo: reader.result }));
                    };
                    reader.readAsDataURL(file);
                }
            };
            const handleRemoveLogo = () => setSettings(prev => ({ ...prev, logo: null }));

            const addSector = () => { if(newSectorName) { setSettings(prev => ({ ...prev, sectors: [...prev.sectors, { id: newSectorName.toLowerCase().replace(/\s+/g, '_'), label: newSectorName }] })); setNewSectorName(''); } };
            const removeSector = (id) => askConfirm('Remover?', 'Confirma?', () => setSettings(prev => ({...prev, sectors: prev.sectors.filter(s => s.id !== id)})));
            const addMachine = () => { if(newMachine.name) { setSettings(prev => ({ ...prev, machines: [...prev.machines, { ...newMachine, id: generateId() }] })); setNewMachine({ name: '', powerWatts: '' }); } };
            const removeMachine = (id) => setSettings(prev => ({ ...prev, machines: prev.machines.filter(m => m.id !== id) }));
            const addEmployee = () => { if(newEmployee.name) { setSettings(prev => ({ ...prev, employees: [...prev.employees, { ...newEmployee, id: generateId(), salary: Number(newEmployee.salary), hoursMonth: Number(newEmployee.hoursMonth) }] })); setNewEmployee({ name: '', salary: '', hoursMonth: 220 }); } };
            const removeEmployee = (id) => setSettings(prev => ({ ...prev, employees: prev.employees.filter(e => e.id !== id) }));

            const handleExportBackup = () => {
                const dataStr = JSON.stringify({ products, settings, ingredients }, null, 2);
                const link = document.createElement('a');
                link.href = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                link.download = `GestorCustos_Backup_${new Date().toISOString().slice(0,10)}.json`;
                link.click();
            };
            const handleImportBackup = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        if(data.products && data.settings) {
                            askConfirm('Restaurar?', 'Substituirá dados atuais.', () => { 
                                setProducts(data.products); 
                                setSettings(data.settings); 
                                if(data.ingredients) setIngredients(data.ingredients);
                                showAlert("Sucesso!"); 
                            });
                        }
                    } catch(err) { showAlert("Erro no arquivo."); }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            const calculateTotals = (product) => {
                const calculateCategory = (catId) => product.items.filter(i => i.category === catId).reduce((acc, curr) => acc + (getItemCost(curr) * safeVal(curr.quantity || 1)), 0);
                
                const laborTotal = calculateCategory('labor');
                const directTotal = calculateCategory('direct');
                const indirectTotal = calculateCategory('indirect');
                
                const machineryTotal = product.machineryItems?.reduce((acc, item) => {
                    const m = settings.machines.find(mach => mach.id == item.machineId) || { powerWatts: 0 };
                    return acc + ((m.powerWatts / 1000) * (safeVal(item.timeMinutes) / 60) * settings.kwhPrice);
                }, 0) || 0;
                
                const totalCost = laborTotal + directTotal + indirectTotal + machineryTotal;
                const totalYieldKg = safeVal(product.yieldUnit) || 1;
                const costPerKg = totalYieldKg > 0 ? totalCost / totalYieldKg : 0;
                
                let totalUnits = 1;
                let unitCost = 0;
                const unitWeight = safeVal(product.unitWeight);

                if (unitWeight && unitWeight > 0) {
                    totalUnits = Math.floor(totalYieldKg / unitWeight);
                    unitCost = totalUnits > 0 ? totalCost / totalUnits : 0;
                } else {
                    unitCost = costPerKg;
                }

                const costBase = costPerKg;
                let suggestedPrice = 0;
                const marginDecimal = (product.targetMargin || 0) / 100;
                
                if (marginDecimal >= 1) {
                    suggestedPrice = 0; 
                } else {
                    suggestedPrice = costBase / (1 - marginDecimal);
                }
                
                const salePrice = safeVal(product.manualSalePrice) || suggestedPrice;
                const grossProfit = salePrice - costBase;
                const marginPercent = salePrice > 0 ? (grossProfit / salePrice) * 100 : 0;
                const markupReal = unitCost > 0 ? (grossProfit / unitCost) * 100 : 0;

                return {
                    laborTotal, directTotal, indirectTotal, machineryTotal,
                    totalCost, costPerKg, unitCost, totalUnits, suggestedPrice, salePrice, grossProfit, marginPercent, markupReal
                };
            };

            const handleAIGeneratedProduct = (aiData) => {
                if (aiData.detectedMachines && Array.isArray(aiData.detectedMachines)) {
                    setSettings(prev => {
                        const newMachines = [...prev.machines];
                        aiData.detectedMachines.forEach(machineName => {
                            const cleanName = machineName.replace(/Energia\s*-\s*/i, '').replace(/Produção\s*-\s*/i, '');
                            if (!newMachines.some(m => m.name.toLowerCase().includes(cleanName.toLowerCase()))) {
                                newMachines.push({ id: generateId(), name: cleanName, powerWatts: 2000 });
                            }
                        });
                        return { ...prev, machines: newMachines };
                    });
                }

                const newProd = {
                ...INITIAL_PRODUCT,
                id: generateId(),
                name: aiData.name || "Receita Importada",
                description: aiData.description || "",
                yieldUnit: aiData.yieldUnit || 1,
                unitWeight: aiData.unitWeight || 0,
                unitName: aiData.unitName || "un",
                sector: aiData.sector || "geral",
                items: aiData.items?.map(item => ({ id: generateId(), ...item })) || [],
                machineryItems: []
                };
                setCurrentProduct(newProd);
                setView('edit');
                if (aiData.detectedMachines?.length > 0) showAlert(`Máquinas identificadas: ${aiData.detectedMachines.join(', ')}.`);
            };

            // --- Views ---

            const renderIngredientsView = () => (
                <div className="max-w-7xl mx-auto p-6 space-y-8 animate-in fade-in duration-300">
                    <div className="flex items-center gap-4 mb-6">
                        <button onClick={() => setView('dashboard')} className="p-2 hover:bg-stone-200 rounded-full transition-colors"><ChevronLeft size={24} className="text-stone-600" /></button>
                        <h2 className="text-2xl font-bold text-stone-900">Estoque de Matéria-Prima</h2>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <Card className="p-6 h-fit">
                            <h3 className="font-semibold text-lg mb-4 flex items-center gap-2" style={{color: BRAND.brown}}><Plus size={20}/> Novo Insumo</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-stone-500 uppercase mb-1">Nome</label>
                                    <input className="w-full p-2 bg-stone-50 border rounded-lg outline-none" value={newIngredient.name} onChange={e => setNewIngredient({...newIngredient, name: e.target.value})} placeholder="Ex: Farinha de Trigo" />
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="block text-xs font-bold text-stone-500 uppercase mb-1">Preço Unitário</label>
                                        <input type="number" step="any" onWheel={(e) => e.target.blur()} className="w-full p-2 bg-stone-50 border rounded-lg outline-none" value={newIngredient.price} onChange={e => setNewIngredient({...newIngredient, price: e.target.value})} placeholder="0.00" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-stone-500 uppercase mb-1">Unidade</label>
                                        <input className="w-full p-2 bg-stone-50 border rounded-lg outline-none" value={newIngredient.unit} onChange={e => setNewIngredient({...newIngredient, unit: e.target.value})} placeholder="kg, L, un" />
                                    </div>
                                </div>
                                <Button onClick={handleAddIngredient} className="w-full">Adicionar ao Estoque</Button>
                            </div>
                        </Card>

                        <Card className="md:col-span-2 p-6">
                            <h3 className="font-semibold text-lg mb-4 flex items-center gap-2" style={{color: BRAND.brown}}><Database size={20}/> Insumos Cadastrados ({ingredients.length})</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-stone-50 text-stone-500 uppercase font-bold text-xs">
                                        <tr>
                                            <th className="px-4 py-3 rounded-l-lg">Nome</th>
                                            <th className="px-4 py-3">Unidade</th>
                                            <th className="px-4 py-3 text-right">Preço Atual</th>
                                            <th className="px-4 py-3 rounded-r-lg text-right">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-stone-100">
                                        {ingredients.map(ing => (
                                            <tr key={ing.id} className="hover:bg-amber-50/50">
                                                <td className="px-4 py-3 font-medium text-stone-800">
                                                    <input 
                                                        className="bg-transparent border-none outline-none w-full font-medium text-stone-800 focus:bg-white focus:ring-1 focus:ring-amber-300 rounded px-1" 
                                                        value={ing.name} 
                                                        onChange={(e) => handleUpdateIngredient(ing.id, 'name', e.target.value)} 
                                                    />
                                                </td>
                                                <td className="px-4 py-3 text-stone-500">
                                                    <input 
                                                        className="bg-transparent border-none outline-none w-16 text-center focus:bg-white focus:ring-1 focus:ring-amber-300 rounded px-1" 
                                                        value={ing.unit} 
                                                        onChange={(e) => handleUpdateIngredient(ing.id, 'unit', e.target.value)} 
                                                    />
                                                </td>
                                                <td className="px-4 py-3 text-right font-bold text-amber-700">
                                                    <div className="flex items-center justify-end gap-1">
                                                        <span>R$</span>
                                                        <input 
                                                            type="number" 
                                                            step="any"
                                                            onWheel={(e) => e.target.blur()}
                                                            className="bg-transparent border-none outline-none w-20 text-right font-bold text-amber-700 focus:bg-white focus:ring-1 focus:ring-amber-300 rounded px-1" 
                                                            value={ing.price} 
                                                            onChange={(e) => handleUpdateIngredient(ing.id, 'price', Number(e.target.value))} 
                                                        />
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 text-right">
                                                    <button onClick={() => handleDeleteIngredient(ing.id)} className="text-stone-400 hover:text-red-500 p-1"><Trash2 size={16}/></button>
                                                </td>
                                            </tr>
                                        ))}
                                        {ingredients.length === 0 && (
                                            <tr><td colSpan="4" className="text-center py-8 text-stone-400">Nenhum insumo cadastrado.</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                    </div>
                </div>
            );

            const renderSettingsView = () => (
                <div className="max-w-4xl mx-auto p-6 space-y-8 animate-in fade-in duration-300">
                <div className="flex items-center gap-4 mb-6">
                    <button onClick={() => setView('dashboard')} className="p-2 hover:bg-stone-200 rounded-full transition-colors"><ChevronLeft size={24} className="text-stone-600" /></button>
                    <h2 className="text-2xl font-bold text-stone-900">Configurações</h2>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Backup Area */}
                    <Card className="p-6 md:col-span-2 bg-gradient-to-r from-stone-50 to-white">
                        <h3 className="font-semibold text-lg mb-4 flex items-center gap-2" style={{color: BRAND.brown}}><Archive size={20} /> Dados e Segurança</h3>
                        <div className="flex gap-4"><Button variant="outline" onClick={handleExportBackup}><Download size={18} /> Backup</Button><div className="relative"><input type="file" ref={backupInputRef} onChange={handleImportBackup} className="absolute inset-0 opacity-0 cursor-pointer" /><Button variant="outline"><Upload size={18} /> Restaurar</Button></div></div>
                    </Card>
                    {/* Logo Upload */}
                    <Card className="p-6 md:col-span-2">
                        <h3 className="font-semibold text-lg mb-4 flex items-center gap-2" style={{color: BRAND.brown}}><ImageIcon size={20} /> Logo da Empresa (PDF)</h3>
                        <div className="flex flex-col md:flex-row gap-6 items-center">
                            <div className="w-32 h-32 border-2 border-dashed border-stone-300 rounded-lg flex items-center justify-center bg-stone-50 relative overflow-hidden group">
                                {settings.logo ? (
                                    <>
                                        <img src={settings.logo} alt="Logo" className="w-full h-full object-contain p-2" />
                                        <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                                            <button onClick={handleRemoveLogo} className="text-white bg-red-500 p-2 rounded-full"><Trash2 size={16}/></button>
                                        </div>
                                    </>
                                ) : (
                                    <div className="text-center text-stone-400">
                                        <ImageIcon className="w-8 h-8 mx-auto mb-1" />
                                        <span className="text-xs">Sem Logo</span>
                                    </div>
                                )}
                            </div>
                            <div className="flex-1 space-y-3">
                                <p className="text-sm text-stone-600">Carregue a logo da sua padaria para aparecer no cabeçalho das Fichas Técnicas (PDF).</p>
                                <div className="relative w-fit">
                                    <input type="file" accept="image/*" onChange={handleLogoUpload} className="absolute inset-0 opacity-0 cursor-pointer w-full" />
                                    <Button variant="secondary"><Upload size={18} /> Selecionar Imagem</Button>
                                </div>
                                <p className="text-xs text-stone-400">Recomendado: PNG ou JPG (max 2MB)</p>
                            </div>
                        </div>
                    </Card>
                    {/* Setores */}
                    <Card className="p-6">
                    <h3 className="font-semibold text-lg mb-4 flex items-center gap-2" style={{color: BRAND.brown}}><Tag size={20} /> Categorias</h3>
                    <div className="flex gap-2 mb-4"><input className="flex-1 border rounded px-3 py-2 text-sm outline-none" placeholder="Nova Categoria" value={newSectorName} onChange={e => setNewSectorName(e.target.value)} /><Button onClick={addSector} variant="secondary"><Plus size={18} /></Button></div>
                    <div className="space-y-2 max-h-40 overflow-y-auto pr-2">{settings.sectors.map((s, i) => (<div key={s.id} className="flex justify-between p-2 bg-stone-50 rounded border"><span className="flex items-center gap-2 text-sm"><div className={`w-3 h-3 rounded-full ${SECTOR_COLORS[i % SECTOR_COLORS.length].split(' ')[0]}`}></div>{s.label}</span><button onClick={() => removeSector(s.id)} className="text-stone-400 hover:text-red-500"><X size={14}/></button></div>))}</div>
                    </Card>
                    {/* Energia */}
                    <Card className="p-6">
                    <h3 className="font-semibold text-lg mb-4 flex items-center gap-2" style={{color: BRAND.yellow}}><Zap size={20} /> Custo Energia</h3>
                    <div className="mb-4"><label className="block text-sm text-stone-600 mb-1">R$ / kWh</label><input type="number" step="0.01" onWheel={(e) => e.target.blur()} className="w-full border rounded px-3 py-2 outline-none" value={settings.kwhPrice} onChange={e => setSettings({...settings, kwhPrice: Number(e.target.value)})} /></div>
                    </Card>
                    {/* Funcionários */}
                    <Card className="p-6 md:col-span-2">
                    <h3 className="font-semibold text-lg mb-4 flex items-center gap-2" style={{color: COST_CATEGORIES.LABOR.color.split('-')[1]}}><Users size={20} /> Mão de Obra</h3>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4 bg-stone-50 p-4 rounded border"><input className="md:col-span-2 border rounded px-3 py-2 text-sm" placeholder="Nome" value={newEmployee.name} onChange={e => setNewEmployee({...newEmployee, name: e.target.value})} /><input type="number" onWheel={(e) => e.target.blur()} className="border rounded px-3 py-2 text-sm" placeholder="Salário" value={newEmployee.salary} onChange={e => setNewEmployee({...newEmployee, salary: e.target.value})} /><input type="number" onWheel={(e) => e.target.blur()} className="border rounded px-3 py-2 text-sm" placeholder="Horas" value={newEmployee.hoursMonth} onChange={e => setNewEmployee({...newEmployee, hoursMonth: e.target.value})} /><div className="md:col-span-4 flex justify-end"><Button onClick={addEmployee} variant="secondary">Adicionar</Button></div></div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">{settings.employees.map(e => (<div key={e.id} className="flex justify-between p-3 border rounded items-center"><div><div className="font-medium text-stone-800">{e.name}</div><div className="text-xs text-stone-500">R${e.salary} / {e.hoursMonth}h</div></div><button onClick={() => removeEmployee(e.id)} className="text-red-400"><Trash2 size={16}/></button></div>))}</div>
                    </Card>
                    {/* Máquinas */}
                    <Card className="p-6 md:col-span-2">
                    <h3 className="font-semibold text-lg mb-4 flex items-center gap-2" style={{color: BRAND.brownLight}}><Settings size={20} /> Máquinas</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 bg-stone-50 p-4 rounded border"><input className="border rounded px-3 py-2 text-sm" placeholder="Nome" value={newMachine.name} onChange={e => setNewMachine({...newMachine, name: e.target.value})} /><input type="number" onWheel={(e) => e.target.blur()} className="border rounded px-3 py-2 text-sm" placeholder="Watts" value={newMachine.powerWatts} onChange={e => setNewMachine({...newMachine, powerWatts: Number(e.target.value)})} /><Button onClick={addMachine} variant="secondary">Adicionar</Button></div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">{settings.machines.map(m => (<div key={m.id} className="flex justify-between p-3 border rounded items-center"><div><div className="font-medium text-stone-800">{m.name}</div><div className="text-xs text-stone-500">{m.powerWatts}W</div></div><button onClick={() => removeMachine(m.id)} className="text-red-400"><Trash2 size={16}/></button></div>))}</div>
                    </Card>
                </div>
                </div>
            );

            const renderDashboard = () => {
                const filtered = products.filter(p => activeFilter === 'all' || p.sector === activeFilter);
                return (
                <div className="max-w-7xl mx-auto p-6 space-y-8 animate-in fade-in duration-500">
                    <header className="flex flex-col md:flex-row justify-between items-center gap-6 border-b border-stone-200 pb-6">
                    <div>
                        <h1 className="text-3xl font-bold text-stone-900 flex items-center gap-3">
                            {settings.logo ? (
                                <img src={settings.logo} alt="Logo" className="w-12 h-12 object-contain rounded-lg bg-white border border-stone-200" />
                            ) : (
                                <div className="p-2 rounded-lg text-white" style={{backgroundColor: BRAND.brown}}>
                                    <Calculator className="w-6 h-6" />
                                </div>
                            )}
                            Fichas de Custo - Controle de Qualidade
                        </h1>
                        <p className="text-stone-500 mt-2 text-sm ml-1">Gerencie custos, defina preços e garanta seu lucro.</p>
                    </div>
                    <div className="flex gap-2 items-center flex-wrap justify-end">
                        <Button variant="outline" onClick={() => window.open('https://jangabrielsg-bit.github.io/ControledeProdu-o/', '_blank')}>
                            <ExternalLink size={18} /> Controle de Rendimentos
                        </Button>
                        <Button variant="outline" onClick={() => setView('ingredients')}><Database size={18} /> Estoque</Button>
                        <Button variant="outline" onClick={() => setImportModal({ isOpen: true })}><FileSpreadsheet size={18} /> Importar IA</Button>
                        <Button variant="outline" onClick={() => setView('settings')}><Settings size={18} /> Config</Button>
                        <Button variant="magic" onClick={() => setAiModal({ isOpen: true, mode: 'create' })}><Sparkles size={18} /> Novo com IA</Button>
                        <Button onClick={handleCreateNew}><Plus size={20} /> Nova Ficha</Button>
                    </div>
                    </header>
                    <div className="flex flex-wrap gap-2 items-center"><span className="text-sm font-medium text-stone-500 flex items-center gap-1 mr-2"><Filter size={16} /> Filtrar:</span><button onClick={() => setActiveFilter('all')} className={`px-4 py-1.5 rounded-full text-sm font-medium transition-all ${activeFilter === 'all' ? 'bg-stone-800 text-white shadow-md' : 'bg-white border text-stone-600 hover:bg-stone-50'}`} style={activeFilter === 'all' ? {backgroundColor: BRAND.brown} : {}}>Todos</button>{settings.sectors.map((s, i) => (<button key={s.id} onClick={() => setActiveFilter(s.id)} className={`px-3 py-1.5 rounded-full text-sm font-medium border ${activeFilter === s.id ? `ring-2 ring-offset-1 ring-stone-400 ${SECTOR_COLORS[i % SECTOR_COLORS.length]}` : 'bg-white text-stone-600 hover:bg-stone-50'}`}>{s.label}</button>))}</div>
                    {filtered.length === 0 ? (<div className="text-center py-24 bg-stone-50 rounded-2xl border-2 border-dashed border-stone-200 flex flex-col items-center"><div className="bg-white p-4 rounded-full shadow-sm mb-4"><Package className="w-12 h-12 text-stone-300" /></div><h3 className="text-xl font-medium text-stone-800 mb-2">Sua cozinha está vazia</h3><Button variant="primary" onClick={handleCreateNew}>Criar Primeiro Produto</Button></div>) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {filtered.map(p => {
                        const t = calculateTotals(p);
                        return (
                            <Card key={p.id} className="hover:shadow-lg transition-all hover:-translate-y-1 cursor-pointer group relative flex flex-col h-full border-l-4 border-l-transparent hover:border-l-amber-600">
                            <div className="p-5 flex-1 flex flex-col" onClick={() => handleEdit(p)}>
                                <div className="flex justify-between items-start mb-3"><span className="text-[10px] uppercase tracking-wider font-bold px-2 py-0.5 rounded bg-stone-100 text-stone-600 border">{settings.sectors.find(s => s.id === p.sector)?.label || 'Geral'}</span>{t.marginPercent > 0 && (<span className={`text-[10px] font-bold px-2 py-0.5 rounded ${t.marginPercent > 30 ? 'bg-green-50 text-green-700' : 'bg-yellow-50 text-yellow-700'}`}>{t.marginPercent.toFixed(0)}% Margem</span>)}</div>
                                <h3 className="font-bold text-lg text-stone-800 line-clamp-1 mb-1">{p.name}</h3><p className="text-stone-500 text-xs line-clamp-2 h-8 mb-4">{p.description || "Sem descrição"}</p>
                                <div className="mt-auto pt-4 border-t border-stone-100 grid grid-cols-2 gap-4"><div><p className="text-[10px] text-stone-400 uppercase font-semibold">Custo Unit.</p><p className="font-bold text-stone-700">R$ {formatMoney(t.unitCost)}</p></div><div className="text-right"><p className="text-[10px] text-stone-400 uppercase font-semibold">Venda Sugerida</p><p className="font-bold text-amber-600">R$ {formatMoney(t.suggestedPrice)}</p></div></div>
                            </div>
                            <div className="bg-stone-50 px-4 py-3 border-t flex justify-end gap-1 opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity"><button onClick={(e) => handleDelete(p.id, e)} className="text-stone-400 hover:text-red-600 p-2"><Trash2 size={16}/></button><button onClick={(e) => handleDuplicate(p, e)} className="text-stone-400 hover:text-amber-600 p-2"><Copy size={16}/></button><button onClick={(e) => { e.stopPropagation(); setCurrentProduct(p); setView('print'); }} className="text-stone-400 hover:text-stone-700 p-2"><Printer size={16}/></button><button onClick={(e) => { e.stopPropagation(); handleEdit(p); }} className="bg-amber-50 text-amber-600 p-2 rounded ml-2"><Edit2 size={16}/></button></div>
                            </Card>
                        );
                        })}
                    </div>
                    )}
                </div>
                );
            };

            const renderEditor = () => {
                const groupedItems = Object.keys(COST_CATEGORIES).reduce((acc, key) => { acc[COST_CATEGORIES[key].id] = currentProduct.items.filter(i => i.category === COST_CATEGORIES[key].id); return acc; }, {});
                const totals = calculateTotals(currentProduct);
                const chartData = [
                { name: 'Insumos', value: totals.directTotal, color: COST_CATEGORIES.DIRECT.barColor },
                { name: 'Mão de Obra', value: totals.laborTotal, color: COST_CATEGORIES.LABOR.barColor },
                { name: 'Maquinário', value: totals.machineryTotal || 0, color: COST_CATEGORIES.ENERGY.barColor },
                { name: 'Indiretos', value: totals.indirectTotal, color: COST_CATEGORIES.INDIRECT.barColor }
                ];

                return (
                <div className="max-w-7xl mx-auto p-4 md:p-6 pb-32 animate-in slide-in-from-right-4 duration-300">
                    <div className="flex flex-col md:flex-row items-center justify-between mb-6 sticky top-0 bg-stone-50/95 backdrop-blur z-20 py-4 border-b gap-4 shadow-sm px-1 -mx-4 md:mx-0 md:px-0">
                    <div className="flex items-center gap-4 pl-4 md:pl-0"><button onClick={() => setView('dashboard')} className="p-2 hover:bg-stone-200 rounded-full"><ChevronLeft size={24} className="text-stone-600" /></button><div><h2 className="text-2xl font-bold text-stone-900 leading-none">{currentProduct.id ? 'Editar Ficha' : 'Nova Ficha'}</h2><p className="text-xs text-stone-500 mt-1">Modo Precificação: Markup Divisor</p></div></div>
                    <div className="flex gap-2 w-full md:w-auto px-4 md:px-0"><Button variant="magic" onClick={() => setAiModal({ isOpen: true, mode: 'analyze' })}><Sparkles size={18} /> Consultor</Button><Button variant="outline" onClick={() => setView('print')}><Printer size={18} /> Visualizar PDF</Button><Button onClick={handleSaveProduct}><Save size={18} /> Salvar</Button></div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div className="lg:col-span-8 space-y-6">
                        <section className="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                        <h3 className="text-lg font-semibold text-stone-800 mb-4 flex items-center gap-2" style={{color: BRAND.brown}}><FileText size={20} /> Identificação</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="md:col-span-2"><label className="block text-xs font-bold uppercase text-stone-500 mb-1">Nome</label><input className="w-full p-2.5 bg-stone-50 border rounded-lg outline-none" value={currentProduct.name} onChange={(e) => setCurrentProduct({...currentProduct, name: e.target.value})} /></div>
                            <div className="md:col-span-2"><label className="block text-xs font-bold uppercase text-stone-500 mb-1">Categoria</label><select className="w-full p-2.5 bg-stone-50 border rounded-lg outline-none" value={currentProduct.sector} onChange={(e) => setCurrentProduct({...currentProduct, sector: e.target.value})}>{settings.sectors.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select></div>
                            <div><label className="block text-xs font-bold uppercase text-stone-500 mb-1">Rendimento (KG)</label><input type="number" step="any" onWheel={(e) => e.target.blur()} className="w-full p-2.5 bg-stone-50 border rounded-lg outline-none" value={currentProduct.yieldUnit} onChange={(e) => setCurrentProduct({...currentProduct, yieldUnit: Number(e.target.value)})} /></div>
                            <div><label className="block text-xs font-bold uppercase text-stone-500 mb-1">Peso Unidade (KG)</label><input type="number" step="any" onWheel={(e) => e.target.blur()} className="w-full p-2.5 bg-stone-50 border rounded-lg outline-none" value={currentProduct.unitWeight || ''} onChange={(e) => setCurrentProduct({...currentProduct, unitWeight: Number(e.target.value)})} /></div>
                        </div>
                        </section>

                        {Object.values(COST_CATEGORIES).map((cat) => (
                        <section key={cat.id} className="bg-white rounded-xl border border-stone-200 shadow-sm overflow-hidden mb-6">
                            <div className={`px-6 py-3 border-b border-stone-100 flex justify-between items-center ${cat.bg}`}>
                            <h3 className={`font-semibold flex items-center gap-2 ${cat.color}`}><cat.icon size={18} /> {cat.label}</h3>
                            <span className="text-sm font-bold text-stone-600">Total: R$ {
                                formatMoney(
                                cat.id === 'energy' 
                                    ? (totals.machineryTotal || 0) 
                                    : calculateCategoryTotal(currentProduct.items, cat.id)
                                )
                            }</span>
                            </div>
                            <div className="p-4 space-y-3">
                                {cat.id === 'energy' ? (
                                <>
                                    <div className="hidden md:grid grid-cols-12 gap-3 text-xs font-bold text-stone-400 uppercase tracking-wider mb-2 px-1">
                                        <div className="col-span-5">Máquina</div>
                                        <div className="col-span-4 text-center">Tempo (min)</div>
                                        <div className="col-span-2 text-right">Custo</div>
                                        <div className="col-span-1"></div>
                                    </div>
                                    {currentProduct.machineryItems?.map((item) => {
                                    const m = settings.machines.find(mach => mach.id == item.machineId);
                                    return (<div key={item.id} className="grid grid-cols-12 gap-2 items-center bg-white p-2 rounded border"><div className="col-span-5"><select className="w-full text-sm border-0 bg-transparent outline-none" value={item.machineId} onChange={(e) => handleUpdateMachineUsage(item.id, 'machineId', e.target.value)}>{settings.machines.map(m => <option key={m.id} value={m.id}>{m.name} ({m.powerWatts}W)</option>)}</select></div><div className="col-span-4 flex items-center gap-1 bg-stone-50 rounded px-2 justify-center"><input type="number" step="any" onWheel={(e) => e.target.blur()} className="w-16 text-sm bg-transparent border-0 outline-none text-right py-1" value={item.timeMinutes} onChange={(e) => handleUpdateMachineUsage(item.id, 'timeMinutes', Number(e.target.value))} /><span className="text-xs text-stone-500">min</span></div><div className="col-span-2 text-right font-medium text-sm text-stone-700">R$ {formatMoney(calculateMachineCost(item))}</div><div className="col-span-1 text-right"><button onClick={() => handleRemoveMachineUsage(item.id)} className="text-stone-400 hover:text-red-500"><Trash2 size={16}/></button></div></div>);
                                    })}
                                    <Button variant="secondary" onClick={handleAddMachineUsage} className="w-full border-dashed"><Plus size={14} /> Add Máquina</Button>
                                </>
                                ) : cat.id === 'indirect' ? (
                                <>
                                    <div className="hidden md:grid grid-cols-12 gap-3 text-xs font-bold text-stone-400 uppercase tracking-wider mb-2 px-1">
                                        <div className="col-span-8">Descrição</div>
                                        <div className="col-span-3 text-right">Valor R$</div>
                                        <div className="col-span-1"></div>
                                    </div>
                                    {groupedItems[cat.id]?.map((item) => (
                                    <div key={item.id} className="grid grid-cols-1 md:grid-cols-12 gap-2 items-center bg-white p-2 rounded border hover:bg-stone-50">
                                        <div className="md:col-span-8"><input type="text" className="w-full text-sm border-0 bg-transparent font-medium outline-none" placeholder="Descrição..." value={item.name} onChange={(e) => handleUpdateItem(item.id, 'name', e.target.value)} /></div>
                                        <div className="md:col-span-3"><input type="number" step="any" onWheel={(e) => e.target.blur()} className="w-full text-sm bg-stone-50 border rounded px-2 py-1 outline-none text-right font-bold" value={item.cost} onChange={(e) => handleUpdateItem(item.id, 'cost', e.target.value)} /></div>
                                        <div className="md:col-span-1 text-right"><button onClick={() => handleRemoveItem(item.id)} className="text-stone-400 hover:text-red-500"><Trash2 size={16} /></button></div>
                                    </div>
                                    ))}
                                    <Button variant="secondary" className="w-full border-dashed" onClick={() => handleAddItem(cat.id)}><Plus size={14} /> Add Item Indireto</Button>
                                </>
                                ) : (
                                <>
                                    <div className="hidden md:grid grid-cols-12 gap-3 text-xs font-bold text-stone-400 uppercase tracking-wider mb-2 px-1">
                                        <div className="col-span-4">Item</div>
                                        <div className="col-span-2 text-center">Qtd</div>
                                        <div className="col-span-1 text-center">Unid</div>
                                        <div className="col-span-2 text-right">R$ Unit</div>
                                        <div className="col-span-2 text-right">Total R$</div>
                                        <div className="col-span-1"></div>
                                    </div>
                                    {groupedItems[cat.id]?.map((item) => {
                                    const isLinked = !!item.ingredientId;
                                    return (
                                    <div key={item.id} className={`grid grid-cols-1 md:grid-cols-12 gap-2 items-center p-2 rounded border hover:bg-stone-50 ${isLinked ? 'bg-amber-50/30 border-amber-200' : 'bg-white'}`}>
                                        <div className="md:col-span-4 flex items-center gap-1">
                                            {/* --- LINK BUTTON (HIDDEN FOR LABOR) --- */}
                                            {cat.id !== 'labor' && (
                                                <button 
                                                    onClick={() => isLinked ? handleUnlinkItem(item) : handleLinkItem(item)}
                                                    className={`p-1.5 rounded hover:bg-stone-200 transition-colors ${isLinked ? 'text-amber-600' : 'text-stone-300'}`}
                                                    title={isLinked ? "Desvincular do estoque" : "Vincular ao estoque"}
                                                >
                                                    {isLinked ? <LinkIcon size={14} /> : <Unlink size={14} />}
                                                </button>
                                            )}
                                            <input type="text" className="w-full text-sm border-0 bg-transparent font-medium outline-none" placeholder="Nome..." value={item.name} onChange={(e) => handleUpdateItem(item.id, 'name', e.target.value)} readOnly={isLinked} />
                                        </div>
                                        <div className="grid grid-cols-3 gap-2 md:contents">
                                            <div className="md:col-span-2"><input type="number" step="any" onWheel={(e) => e.target.blur()} className="w-full text-sm bg-stone-50 border rounded px-2 py-1 outline-none text-center" value={item.quantity} onChange={(e) => handleUpdateItem(item.id, 'quantity', e.target.value)} /></div>
                                            <div className="md:col-span-1"><input type="text" className="w-full text-sm bg-stone-50 border rounded px-2 py-1 outline-none text-center" value={item.unit} onChange={(e) => handleUpdateItem(item.id, 'unit', e.target.value)} readOnly={isLinked} /></div>
                                            <div className="md:col-span-2 relative">
                                                <input 
                                                    type="number" 
                                                    step="any" 
                                                    onWheel={(e) => e.target.blur()}
                                                    className={`w-full text-sm border rounded px-2 py-1 outline-none text-right ${isLinked ? 'bg-amber-50 text-stone-500' : 'bg-stone-50'}`} 
                                                    value={getItemCost(item)} 
                                                    onChange={(e) => handleUpdateItem(item.id, 'cost', e.target.value)}
                                                    readOnly={isLinked}
                                                />
                                                {isLinked && <span className="absolute right-8 top-1.5 text-[10px] text-amber-500 font-bold pointer-events-none">AUTO</span>}
                                            </div>
                                            <div className="md:col-span-2 text-right font-bold text-stone-700 pt-1 md:pt-0">R$ {formatMoney(getItemCost(item) * item.quantity)}</div>
                                        </div>
                                        <div className="md:col-span-1 text-right"><button onClick={() => handleRemoveItem(item.id)} className="text-stone-400 hover:text-red-500"><Trash2 size={16} /></button></div>
                                    </div>
                                    )})}
                                    {cat.id === 'labor' ? (
                                    <div className="bg-orange-50 p-3 rounded-lg border border-orange-200 mt-2 flex flex-col md:flex-row gap-3 items-center"><div className="flex-1 w-full"><select className="w-full text-sm border border-orange-300 rounded px-2 py-1.5 outline-none bg-white" value={laborSelection.employeeId} onChange={(e) => setLaborSelection({...laborSelection, employeeId: e.target.value})}><option value="">Selecionar Funcionário...</option>{settings.employees?.map(emp => (<option key={emp.id} value={emp.id}>{emp.name}</option>))}</select></div><div className="flex items-center gap-2"><input type="number" onWheel={(e) => e.target.blur()} placeholder="Min" className="w-16 text-sm border border-orange-300 rounded px-2 py-1.5 outline-none" value={laborSelection.minutes} onChange={(e) => setLaborSelection({...laborSelection, minutes: e.target.value})} /><span className="text-xs text-orange-600">min</span></div><Button variant="secondary" onClick={handleAddLaborItem} className="bg-white border-orange-300 text-orange-700">Add</Button></div>
                                    ) : ( <Button variant="secondary" className="w-full border-dashed" onClick={() => handleAddItem(cat.id)}><Plus size={14} /> Add Item</Button> )}
                                </>
                                )}
                            </div>
                        </section>
                        ))}
                    </div>

                    <div className="lg:col-span-4 space-y-6">
                        <Card className="p-6"><h3 className="text-sm font-bold text-stone-500 uppercase tracking-wider mb-4 text-center">Composição</h3><DonutChart data={chartData} /><div className="mt-6 space-y-2 text-sm">{chartData.map((d, i) => d.value > 0 && (<div key={i} className="flex justify-between"><span className="flex items-center gap-2"><div className="w-2 h-2 rounded-full" style={{backgroundColor: d.color}}></div> {d.name}</span><span className="font-medium">{((d.value/totals.totalCost)*100).toFixed(1)}%</span></div>))}</div></Card>

                        <Card className="p-0 overflow-hidden border-amber-100 ring-2 ring-amber-50">
                            <div className="p-4 text-white" style={{backgroundColor: BRAND.brown}}><h3 className="font-bold flex items-center gap-2"><DollarSign size={20} /> Precificação (Markup Divisor)</h3></div>
                            <div className="p-5 space-y-6">
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-bold text-stone-500 uppercase mb-1">Margem Meta (%)</label><div className="relative"><input type="number" step="any" onWheel={(e) => e.target.blur()} className="w-full p-2 bg-amber-50 border border-amber-100 rounded text-amber-900 font-bold outline-none" value={currentProduct.targetMargin} onChange={(e) => setCurrentProduct({...currentProduct, targetMargin: Number(e.target.value)})} /><span className="absolute right-3 top-2 text-amber-300 text-sm">%</span></div></div>
                                    <div><label className="block text-xs font-bold text-stone-500 uppercase mb-1">Custo do Kg</label><div className="w-full p-2 bg-stone-100 border border-stone-200 rounded text-stone-600 font-bold">R$ {formatMoney(totals.costPerKg)}</div></div>
                                </div>
                                <div className="bg-amber-50 p-4 rounded-lg border border-amber-100 text-center"><span className="text-xs text-amber-500 font-bold uppercase block mb-1">Preço Sugerido (Kg)</span><span className="text-3xl font-bold text-amber-700 block">R$ {formatMoney(totals.suggestedPrice)}</span><span className="text-xs text-amber-400">P/ Margem Bruta de {currentProduct.targetMargin}%</span></div>
                                <hr className="border-stone-100" />
                                <div><label className="block text-xs font-bold text-stone-800 uppercase mb-2 flex items-center gap-1"><TrendingUp size={14} /> Preço Real de Venda (Kg)</label><input type="number" onWheel={(e) => e.target.blur()} className="w-full p-3 bg-white border-2 border-stone-200 rounded-lg text-lg font-bold text-stone-900 outline-none focus:border-green-500" placeholder={formatMoney(totals.suggestedPrice)} value={currentProduct.manualSalePrice || ''} onChange={(e) => setCurrentProduct({...currentProduct, manualSalePrice: Number(e.target.value)})} step="0.01" /></div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className={`p-3 rounded border ${totals.marginPercent < 0 ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}`}><span className="block text-[10px] uppercase font-bold opacity-70">Margem Real</span><span className="block text-xl font-bold">{formatMoney(totals.marginPercent)}%</span></div>
                                    <div className={`p-3 rounded border ${totals.grossProfit < 0 ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}`}><span className="block text-[10px] uppercase font-bold opacity-70">Lucro / Kg</span><span className="block text-xl font-bold">R$ {formatMoney(totals.grossProfit)}</span></div>
                                </div>
                            </div>
                        </Card>

                        <Card className="p-6 bg-stone-900 text-white border-none shadow-xl">
                            <h3 className="text-sm font-bold text-stone-400 mb-4 uppercase tracking-wider">Totais de Produção</h3>
                            <div className="space-y-4">
                            <div className="flex justify-between items-end pb-2 border-b border-stone-700"><span className="text-sm text-stone-400">Custo Total Lote</span><span className="text-xl font-bold">R$ {formatMoney(totals.totalCost)}</span></div>
                            <div className="flex justify-between items-end pb-2 border-b border-stone-700"><span className="text-sm text-stone-400">Peso Total</span><span className="text-lg text-stone-200">{currentProduct.yieldUnit} kg</span></div>
                            {currentProduct.unitWeight > 0 && (<div className="flex justify-between items-end pb-2 border-b border-stone-700"><span className="text-sm text-stone-400">Rendimento</span><span className="text-lg text-stone-200">{totals.totalUnits} un</span></div>)}
                            <div className="pt-2"><span className="text-xs text-stone-500 uppercase">Custo do Quilo</span><div className="text-2xl font-bold text-green-400">R$ {formatMoney(totals.costPerKg)}</div></div>
                            </div>
                        </Card>
                    </div>
                    </div>
                </div>
                );
            };

            const renderPrintView = () => {
                const totals = calculateTotals(currentProduct);
                const date = new Date().toLocaleDateString('pt-BR');
                return (
                <div className="min-h-screen bg-stone-500 p-8 print:p-0 print:bg-white flex justify-center">
                    <div className="fixed top-4 right-4 flex gap-2 print:hidden z-50"><Button variant="secondary" onClick={() => setView('edit')}><ChevronLeft size={18} /> Voltar</Button><Button onClick={() => { window.focus(); setTimeout(() => window.print(), 200); }}><Printer size={18} /> Imprimir</Button></div>
                    <div className="bg-white w-[210mm] min-h-[297mm] p-[15mm] shadow-2xl print:shadow-none text-black relative flex flex-col">
                    
                    {/* --- CABEÇALHO REPOSICIONADO: LOGO CENTRALIZADA --- */}
                    <div className="border-b-4 pb-6 mb-8 text-center" style={{borderColor: BRAND.brown}}>
                        {settings.logo ? (
                            <div className="flex justify-center mb-4">
                                <img src={settings.logo} alt="Logo da Empresa" className="h-24 object-contain" />
                            </div>
                        ) : (
                            <div className="h-20 w-48 mx-auto mb-4 flex items-center justify-center border-2 border-dashed border-stone-300 rounded-lg text-stone-400 font-bold bg-stone-50">SUA LOGO</div>
                        )}
                        <h1 className="text-4xl font-extrabold tracking-tight uppercase" style={{color: BRAND.brown}}>Ficha de Custo</h1>
                        <p className="text-stone-500 text-sm mt-1">Gerado em {date}</p>
                    </div>

                    <div className="flex justify-between items-end mb-8">
                        <div>
                            <span className="text-xs uppercase px-3 py-1 rounded font-bold tracking-wider text-white" style={{backgroundColor: BRAND.brown}}>
                                {settings.sectors.find(s => s.id === currentProduct.sector)?.label || 'Geral'}
                            </span>
                            <h2 className="text-3xl font-bold text-stone-800 mt-2">{currentProduct.name}</h2>
                        </div>
                        {/* Dados rápidos de rendimento */}
                        <div className="text-right">
                            <div className="text-sm font-bold text-stone-500 uppercase">Rendimento</div>
                            <div className="text-2xl font-bold" style={{color: BRAND.brown}}>{currentProduct.yieldUnit} kg</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 gap-6 mb-8">
                        <div className="bg-stone-50 p-4 rounded-lg border border-stone-100">
                            <span className="block text-[10px] uppercase text-stone-500 font-bold mb-1">Descrição</span>
                            <p className="text-stone-800 text-sm leading-relaxed">{currentProduct.description || 'Nenhuma descrição informada.'}</p>
                        </div>
                    </div>

                    <div className="mb-8">
                        <h3 className="font-bold uppercase text-sm border-b-2 pb-2 mb-4" style={{borderColor: BRAND.brown, color: BRAND.brown}}>Detalhamento de Custos</h3>
                        <table className="w-full text-sm">
                            <thead>
                                <tr className="text-left text-xs text-stone-500 uppercase border-b border-stone-200">
                                    <th className="py-2 w-5/12 font-bold">Item</th>
                                    <th className="py-2 text-center w-2/12 font-bold">Tipo</th>
                                    <th className="py-2 text-right w-1/12 font-bold">Qtd</th>
                                    <th className="py-2 text-right w-2/12 font-bold">Vlr Unit</th>
                                    <th className="py-2 text-right w-2/12 font-bold">Total</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-stone-100">
                                {currentProduct.items.map(item => (
                                    <tr key={item.id}>
                                        <td className="py-2 text-stone-800 font-medium">{item.name}</td>
                                        <td className="py-2 text-center"><span className="text-[10px] px-2 py-0.5 rounded bg-stone-100 text-stone-600 uppercase font-bold">{Object.values(COST_CATEGORIES).find(c => c.id === item.category)?.label.split(' ')[0]}</span></td>
                                        <td className="py-2 text-right text-stone-600">{item.category === 'indirect' ? '-' : (item.quantity + ' ' + (item.unit || ''))}</td>
                                        <td className="py-2 text-right text-stone-600">{item.category === 'indirect' ? '-' : 'R$ ' + formatMoney(getItemCost(item))}</td>
                                        <td className="py-2 text-right font-bold text-stone-800">R$ {formatMoney(getItemCost(item) * (item.category === 'indirect' ? 1 : item.quantity))}</td>
                                    </tr>
                                ))}
                                {currentProduct.machineryItems?.map(item => {
                                    const m = settings.machines.find(mach => mach.id == item.machineId) || { name: 'Máquina', powerWatts: 0 };
                                    const cost = calculateMachineCost(item);
                                    return (
                                        <tr key={item.id}>
                                            <td className="py-2 text-stone-800 font-medium">{m.name} ({m.powerWatts}W)</td>
                                            <td className="py-2 text-center"><span className="text-[10px] px-2 py-0.5 rounded bg-stone-100 text-stone-600 uppercase font-bold">Energia</span></td>
                                            <td className="py-2 text-right text-stone-600">{item.timeMinutes} min</td>
                                            <td className="py-2 text-right text-stone-600">-</td>
                                            <td className="py-2 text-right font-bold text-stone-800">R$ {formatMoney(cost)}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    <div className="mt-auto pt-4 border-t-2" style={{borderColor: BRAND.brown}}>
                        <div className="flex justify-end">
                            <div className="w-1/2 bg-stone-50 p-6 rounded-xl border border-stone-200">
                                <div className="flex justify-between text-stone-600 mb-2 text-sm">
                                    <span>Soma Total dos Custos:</span>
                                    <span className="font-bold text-stone-800">R$ {formatMoney(totals.totalCost)}</span>
                                </div>
                                <div className="flex justify-between text-stone-600 mb-4 text-sm border-b border-stone-200 pb-2">
                                    <span>Custo por Quilo:</span>
                                    <span className="font-bold text-stone-800">R$ {formatMoney(totals.costPerKg)}</span>
                                </div>
                                
                                <div className="flex justify-between items-center mb-2">
                                    <div>
                                        <span className="block text-xs uppercase text-stone-500 font-bold mb-1">Custo Unitário</span>
                                        <span className="block text-2xl font-extrabold text-stone-900">R$ {formatMoney(totals.unitCost)}</span>
                                    </div>
                                    <div className="text-right">
                                        <span className="block text-xs uppercase text-stone-500 font-bold mb-1">Preço Sugerido</span>
                                        <span className="block text-2xl font-extrabold" style={{color: BRAND.brown}}>R$ {formatMoney(totals.suggestedPrice)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    </div>
                </div>
                );
            };

            const calculateCategoryTotal = (items, categoryId) => { return items.filter(i => i.category === categoryId).reduce((acc, curr) => acc + (getItemCost(curr) * (categoryId === 'indirect' ? 1 : safeVal(curr.quantity || 1))), 0); };

            return (
                <div className="min-h-screen bg-stone-50 text-stone-900 font-sans selection:bg-amber-100 selection:text-amber-900" style={{backgroundColor: BRAND.bg}}>
                {view === 'dashboard' && renderDashboard()}
                {view === 'edit' && renderEditor()}
                {view === 'settings' && renderSettingsView()}
                {view === 'print' && renderPrintView()}
                {view === 'ingredients' && renderIngredientsView()}
                <ConfirmModal isOpen={confirmModal.isOpen} onClose={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))} onConfirm={confirmModal.onConfirm} title={confirmModal.title} message={confirmModal.message} />
                <AlertModal isOpen={alertModal.isOpen} onClose={closeAlert} message={alertModal.message} />
                <SelectIngredientModal isOpen={ingredientModalOpen} onClose={() => setIngredientModalOpen(false)} ingredients={ingredients} onSelect={handleSelectIngredientForLink} />
                <AIModal isOpen={aiModal.isOpen} onClose={() => setAiModal({ ...aiModal, isOpen: false })} mode={aiModal.mode} onGenerate={handleAIGeneratedProduct} productToAnalyze={currentProduct} kwhPrice={settings.kwhPrice} />
                <ImportModal isOpen={importModal.isOpen} onClose={() => setImportModal({ isOpen: false })} onImport={(data) => { handleAIGeneratedProduct(data); setImportModal({ isOpen: false }); }} />
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
